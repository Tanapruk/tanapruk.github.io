<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasscodeSettingFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ais.mimo.eservice.module.setting.fragment.passcode</a> &gt; <span class="el_source">PasscodeSettingFragment.java</span></div><h1>PasscodeSettingFragment.java</h1><pre class="source lang-java linenums">package com.ais.mimo.eservice.module.setting.fragment.passcode;

import android.content.Intent;
import android.os.Bundle;
import android.support.annotation.Nullable;
import android.view.View;

import com.ais.mimo.eservice.module.setting.activity.SettingActivity;
import com.ais.mimo.eservice.module.setting.changePasscode.ChangePasscodeActivity;
import com.ais.mimo.eservice.widget.MenuSettingSimpleUnderScrollView;
import com.ais.mimo.eservice.widget.MenuSettingSwitchView;
import com.nextzy.myais.common.config.mobile.Mobile;
import com.nextzy.myais.common.mvp.NextzyMvpFragment;
import com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager;
import com.nextzy.myais.common.passcode.network.response.BindFingerScanResult;
import com.nextzy.myais.common.utility.DefaultPreference;
import com.nextzy.myais.common.utility.NextzyAndroidUtility;
import com.nextzy.myais.common.widget.AISDivider;
import com.nextzy.myais.common.widget.dialog.AisDialog;
import com.nextzy.myais.common.widget.dialog.listener.ChoiceDialogClickListener;
import com.nextzy.myais.myais.R;

import java.util.Map;

import static com.ais.mimo.eservice.module.setting.changePasscode.ChangePasscodeActivity.RESULT_NEW_PASSCODE;
import static com.nextzy.myais.common.utility.DefaultPreference.KEY_PRIVATE_ID;
import static com.nextzy.myais.common.utility.DefaultPreference.KEY_TOKEN;

public class PasscodeSettingFragment extends NextzyMvpFragment&lt;PasscodeSettingContractor.Presenter&gt;
        implements PasscodeSettingContractor.View,
        MenuSettingSwitchView.OnCheckedChangeListener,
        View.OnClickListener {
    private final static String TAG = PasscodeSettingFragment.class.getSimpleName();
    private static final int REQUEST_FIRST_PASSCODE = 1000;
    private final DefaultPreference preference;
    private final NextzyAndroidUtility androidUtil;
    private final NextzyFingerprintManager fingerManager;
    private MenuSettingSwitchView msPasscodeLock;
    private MenuSettingSimpleUnderScrollView msChangePasscode;
    private MenuSettingSwitchView msTouchId;
    private AISDivider dvChangePasscode;
    private AISDivider dvTouchId;

    public PasscodeSettingFragment() {
        super();
        preference = DefaultPreference.getInstance();
        androidUtil = NextzyAndroidUtility.getInstance();
        fingerManager = NextzyFingerprintManager.getInstance();
    }

    public static PasscodeSettingFragment newInstance() {
        PasscodeSettingFragment fragment = new PasscodeSettingFragment();
        Bundle args = new Bundle();
        fragment.setArguments(args);
        return fragment;
    }

    /*************************/
    /** Fragment life cycle **/
    /*************************/
    //&lt;editor-fold desc=&quot;Life cycle folding&quot;&gt;

    /**
     * onCreateView
     **/
    @Override
    public int getLayoutView() {
        return R.layout.my_ais_setting_fragment_passcode;
    }

    /**
     * onCreate()
     **/
    @Override
    protected void createPresenter() {
        PasscodeSettingPresenter.createPresenter(this);
    }

    @Override
    public void restoreArgument(Bundle bundle) {

    }

    /**
     * onViewCreated()
     **/
    @Override
    public void bindView(View view) {
        msPasscodeLock = (MenuSettingSwitchView) view.findViewById(R.id.my_ais_setting_ms_passcode_lock);
        dvChangePasscode = (AISDivider) view.findViewById(R.id.my_ais_setting_divider_change_passcode);
        msChangePasscode = (MenuSettingSimpleUnderScrollView) view.findViewById(R.id.my_ais_setting_ms_change_passcode);
        dvTouchId = (AISDivider) view.findViewById(R.id.my_ais_setting_divider_touch_id);
        msTouchId = (MenuSettingSwitchView) view.findViewById(R.id.my_ais_setting_ms_touch_id);
    }

    @Override
    public void setupView() {
        dismissAllDialogs(); // make sure dialog dismiss when restore view
        msPasscodeLock.setOnCheckedChangeListener(this);
        msPasscodeLock.setAutoSwitch(false);
        msChangePasscode.setOnClickListener(this);
        msTouchId.setOnCheckedChangeListener(this);
        fingerManager.init(this, () -&gt; {
            updateTouchIdSetting();
            setupToolbarTitle();
        });
        updatePasscodeLockSetting();
    }

    private void setupToolbarTitle() {
        if (getActivity() instanceof SettingActivity) {
            if (fingerManager.isFingerprintSupported(getContext())
                    &amp;&amp; fingerManager.isFingerprintEnrolled(getContext())) {
                ((SettingActivity) getActivity()).setToolbarTitle(getString(R.string.my_ais_setting_passcode_and_touch_id));
            } else {
                ((SettingActivity) getActivity()).setToolbarTitle(getString(R.string.my_ais_setting_passcode));
            }
        }
    }

    @Override
    public void initialize() {
    }

    @Override
    public void restoreView() {
    }

    @Override
    public void onResume() {
        super.onResume();
        updateTouchIdSetting();
    }

    /**
     * State
     **/
    @Override
    public void saveInstanceState(Bundle outState) {
        // Save Instance State here
    }

    @Override
    public void restoreInstanceState(Bundle savedInstanceState) {
        // Restore instance state here

    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (requestCode == REQUEST_FIRST_PASSCODE) {
            if (resultCode == RESULT_NEW_PASSCODE) {
                updatePasscodeLockSetting();
            }
        } else {
            super.onActivityResult(requestCode, resultCode, data);
        }
    }
    //&lt;/editor-fold&gt;

    @Override
    public void onClick(View view) {
        if (view == msChangePasscode) {
            clickChangePasscode();
        }
    }

    @Override
    public void onCheckedChanged(View view, boolean isChecked) {
        if (view == msPasscodeLock) {
            onPasscodeLockCheck(isChecked);
        } else if (view == msTouchId) {
            onTouchIdCheck(isChecked);
        }
    }


    public void checkTouchId() {
        preference.saveTouchIdSwitchSetting(true);
    }

    public void unCheckTouchId() {
        preference.saveTouchIdSwitchSetting(false);
    }

    @Override
    public void updatePasscodeLockSetting() {
        boolean isPasscodeLock = loadPasscodeLockSetting();
        msPasscodeLock.setChecked(isPasscodeLock);
        if (isPasscodeLock) {
            showChangePasscodeSettingView();
            updateTouchIdSetting();
        } else {
            disableChangePasscodeSettingView();
            disableTouchIdSettingView();
        }

    }

    private void updateTouchIdSetting() {
        showTouchIdSettingViewIfAvailable();
        if (loadTouchIdSetting()) {
            msTouchId.setChecked(true);
        } else {
            msTouchId.setChecked(false);
        }
    }

    @Override
    public void saveBindFingerScanData(BindFingerScanResult result) {
        String privateId = result.getData().getPrivateId();
        String token = result.getData().getToken();
        String masterNumber = Mobile.getInstance().getMasterMobileNumber();
        preference.saveMasterNumberAndPrivateIdAndToken(
                masterNumber,
                privateId,
                token);
        updatePasscodeLockSetting();
    }

    @Override
    public void removeAllPasscodeData() {
        preference.removeAllPasscodeData();
    }

    @Override
    public boolean isFirstEnablePasscodeLock() {
        return preference.loadPasscode() == null;
    }

    @Override
    public void openFirstNewPasscodeActivity() {
        openActivityOnResult(ChangePasscodeActivity.class, REQUEST_FIRST_PASSCODE);
    }

    @Override
    public void showResponseException(String resultDescription) {
        showAlertDialogDismissOnClick(resultDescription);
    }

    @Override
    public void showResponseException() {
        showAlertDialogDismissOnClick(R.string.my_ais_server_unavailable);
    }

    private void showConfirmDisablePasscodeDialog() {
        AisDialog.getInstance().showChoiceDialog(getFragmentManager(),
                null,
                getString(R.string.my_ais_setting_disable_passcode),
                getString(R.string.ok),
                getString(R.string.cancel),
<span class="nc" id="L252">                new ChoiceDialogClickListener() {</span>
                    @Override
                    public void onDialogPositiveButtonClick(@Nullable Bundle data) {
<span class="nc" id="L255">                        dismissDialog();</span>
<span class="nc" id="L256">                        Map&lt;String, String&gt; result = preference.loadPrivateIdAndToken();</span>
<span class="nc" id="L257">                        String privateId = result.get(KEY_PRIVATE_ID);</span>
<span class="nc" id="L258">                        String token = result.get(KEY_TOKEN);</span>
<span class="nc" id="L259">                        getPresenter().disablePasscodeLock(privateId, token);</span>
<span class="nc" id="L260">                    }</span>

                    @Override
                    public void onDialogNegativeButtonClick(@Nullable Bundle data) {
<span class="nc" id="L264">                        dismissDialog();</span>
<span class="nc" id="L265">                    }</span>
                });
    }


    /*******************/
    /** Click &amp; Check **/
    /*******************/
    //&lt;editor-fold desc=&quot;Click &amp; Check folding&quot;&gt;
    private void clickChangePasscode() {
        String passcode = preference.loadPasscode();
        getPresenter().openChangePasscodeActivity(passcode);
    }

    private void onPasscodeLockCheck(boolean isChecked) {
        if (isChecked) {
            enablePasscodeLockSetting();
        } else {
            disablePasscodeLockSetting();
        }
    }

    private void onTouchIdCheck(boolean isChecked) {
        if (isChecked) {
            enableTouchIdSetting();
        } else {
            disableTouchIdSetting();
        }
    }
    //&lt;/editor-fold&gt;

    /***************/
    /** Show view **/
    /***************/
    //&lt;editor-fold desc=&quot;Show view folding&quot;&gt;
    private void showTouchIdSettingViewIfAvailable() {
        if (preference.loadPasscodeSwitchSetting()
                &amp;&amp; fingerManager.isFingerprintSupported(getContext())
                &amp;&amp; fingerManager.isFingerprintEnrolled(getContext())
                &amp;&amp; preference.loadPasscode() != null) {
            showTouchIdSettingView();
        } else {
            disableTouchIdSettingView();
        }
    }

    private void showChangePasscodeSettingView() {
        dvChangePasscode.setVisibility(View.VISIBLE);
        msChangePasscode.setVisibility(View.VISIBLE);
    }

    private void showTouchIdSettingView() {
        dvTouchId.setVisibility(View.VISIBLE);
        msTouchId.setVisibility(View.VISIBLE);
    }
    //&lt;/editor-fold&gt;

    /******************/
    /** Disable view **/
    /******************/
    //&lt;editor-fold desc=&quot;Disable view folding&quot;&gt;
    private void disableChangePasscodeSettingView() {
        dvChangePasscode.setVisibility(View.GONE);
        msChangePasscode.setVisibility(View.GONE);
    }


    private void disableTouchIdSettingView() {
        dvTouchId.setVisibility(View.GONE);
        msTouchId.setVisibility(View.GONE);
    }
    //&lt;/editor-fold&gt;

    /********************/
    /** Private method **/
    /********************/
    //&lt;editor-fold desc=&quot;Private function folding&quot;&gt;
    private void enableTouchIdSetting() {
        checkTouchId();
    }

    private void disableTouchIdSetting() {
        unCheckTouchId();
    }

    private void enablePasscodeLockSetting() {
        String deviceId = androidUtil.getDeviceId(getActivity());
        String deviceModel = androidUtil.getDeviceModel();
        getPresenter().enablePasscodeLock(deviceId, deviceModel);
    }

    private void disablePasscodeLockSetting() {
        showConfirmDisablePasscodeDialog();
    }


    private boolean loadPasscodeLockSetting() {
        return preference.loadPasscodeSwitchSetting();
    }

    private boolean loadTouchIdSetting() {
        return preference.loadTouchIdSwitchSetting();
    }
    //&lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>