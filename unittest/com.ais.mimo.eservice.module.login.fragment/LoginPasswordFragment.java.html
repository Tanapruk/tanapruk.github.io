<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoginPasswordFragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ais.mimo.eservice.module.login.fragment</a> &gt; <span class="el_source">LoginPasswordFragment.java</span></div><h1>LoginPasswordFragment.java</h1><pre class="source lang-java linenums">package com.ais.mimo.eservice.module.login.fragment;

import android.os.Bundle;
import android.support.annotation.NonNull;
import android.text.InputFilter;
import android.text.InputType;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.TextView;

import com.ais.mimo.eservice.helper.devtool.NextzyInjector;
import com.ais.mimo.eservice.module.forgot.ForgotPasswordActivity;
import com.ais.mimo.eservice.module.login.LoginKey;
import com.nextzy.myais.common.config.mobile.Mobile;
import com.nextzy.myais.common.utility.NextzyBitmapUtility;
import com.nextzy.myais.common.widget.dialog.listener.SimpleDialogClickListener;
import com.nextzy.myais.myais.R;

import java.util.concurrent.TimeUnit;

import rx.Observable;

/**
 * Created by trusttanapruk on 8/17/2016.
 */
<span class="nc" id="L28">public class LoginPasswordFragment extends LoginBaseFragment implements NextzyInjector {</span>
    private static final String KEY_OTP_OR_PASSWORD = &quot;OTP_OR_PASSWORD&quot;;
    private static final String KEY_REFERENCE_ID = &quot;REFERENCE_ID&quot;;
    private static final String KEY_OTP_METHOD = &quot;OTP_METHOD&quot;;
    private static final String KEY_CAPTCHA = &quot;CAPTCHA&quot;;
    //    private static final String KEY_SHOW_CAPTCHA = &quot;SHOW_CAPTCHA&quot;;
    private static final String KEY_PASSWORD_ERROR_COUNT = &quot;PASSWORD_ERROR_COUNT&quot;;

    //    private boolean shouldShowCaptcha = false;
    private View layoutCaptcha;
    private TextView tvHint;
    private EditText etMobileNumber;
    private EditText etPassword;
    private EditText etCaptcha;
    private Button btnCancel;
    private Button btnOk;
    private String otpOrPassword;
    private String referenceId;
    private String captcha;
    private String otpMethod;
    private ImageView ivCaptcha;

    public static LoginPasswordFragment newInstance(String otpOrPassword, String referenceId, String otpMethod, String captcha) {
<span class="nc" id="L51">        Bundle args = new Bundle();</span>
<span class="nc" id="L52">        args.putString(KEY_OTP_OR_PASSWORD, otpOrPassword);</span>
<span class="nc" id="L53">        args.putString(KEY_REFERENCE_ID, referenceId);</span>
<span class="nc" id="L54">        args.putString(KEY_OTP_METHOD, otpMethod);</span>
<span class="nc" id="L55">        args.putString(KEY_CAPTCHA, captcha);</span>
<span class="nc" id="L56">        LoginPasswordFragment fragment = new LoginPasswordFragment();</span>
<span class="nc" id="L57">        fragment.setArguments(args);</span>
<span class="nc" id="L58">        return fragment;</span>
    }

    @Override
    public int getLayoutView() {
<span class="nc" id="L63">        return R.layout.my_ais_login_fragment_password;</span>
    }

    @Override
    public void bindView(View view) {
<span class="nc" id="L68">        etMobileNumber = (EditText) view.findViewById(R.id.my_ais_login_password_page_et_mobile_number);</span>
<span class="nc" id="L69">        etCaptcha = (EditText) view.findViewById(R.id.my_ais_login_et_password_page_captcha);</span>
<span class="nc" id="L70">        layoutCaptcha = view.findViewById(R.id.my_ais_login_password_layout_captcha);</span>
<span class="nc" id="L71">        ivCaptcha = (ImageView) view.findViewById(R.id.my_ais_login_iv_password_page_captcha);</span>
<span class="nc" id="L72">        tvHint = (TextView) view.findViewById(R.id.my_ais_login_password_page_tv_hint);</span>
<span class="nc" id="L73">        etPassword = (EditText) view.findViewById(R.id.my_ais_login_password_page_et_otp_or_password);</span>
<span class="nc" id="L74">        btnCancel = (Button) view.findViewById(R.id.my_ais_login_password_page_btn_cancel);</span>
<span class="nc" id="L75">        btnOk = (Button) view.findViewById(R.id.my_ais_login_password_page_btn_ok);</span>
<span class="nc" id="L76">        bindTermForgotPasswordLanguageBar(view);</span>
<span class="nc" id="L77">    }</span>

    @Override
    protected int idTermAndConditionView() {
<span class="nc" id="L81">        return R.id.my_ais_login_tv_login_term_and_condition;</span>
    }

    @Override
    protected int idTvForgetPassword() {
<span class="nc" id="L86">        return R.id.my_ais_login_password_page_tv_forgot_password;</span>
    }

    @Override
    protected int idTvLanguageBar() {
<span class="nc" id="L91">        return R.id.my_ais_login_password_view_change_language;</span>
    }

    @Override
    public void setupView() {
<span class="nc" id="L96">        btnCancel.setOnClickListener(onCancelButtonClick());</span>
<span class="nc" id="L97">        btnOk.setOnClickListener(onOkButtonClick());</span>
<span class="nc" id="L98">        hideForgotPasswordButton();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (hasCaptcha()) {</span>
<span class="nc" id="L100">            setCaptchaImage(captcha);</span>
        }
<span class="nc" id="L102">    }</span>


    @Override
    public void restoreArgument(Bundle bundle) {
<span class="nc" id="L107">        otpOrPassword = bundle.getString(KEY_OTP_OR_PASSWORD);</span>
<span class="nc" id="L108">        referenceId = bundle.getString(KEY_REFERENCE_ID);</span>
<span class="nc" id="L109">        captcha = bundle.getString(KEY_CAPTCHA);</span>
<span class="nc" id="L110">        otpMethod = bundle.getString(KEY_OTP_METHOD);</span>
//        shouldShowCaptcha = bundle.getBoolean(KEY_SHOW_CAPTCHA, false);
<span class="nc" id="L112">    }</span>

    private void initByType() {
<span class="nc" id="L115">        checkCaptcha();</span>
<span class="nc" id="L116">        etMobileNumber.setText(Mobile.getInstance().getMobileNumber());</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (isSmsType()) {</span>
<span class="nc" id="L118">            initForSms();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        } else if (isEmailType()) {</span>
<span class="nc" id="L120">            initForEmail();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        } else if (isPasswordType()) {</span>
<span class="nc" id="L122">            initForPassword();</span>
        }
<span class="nc" id="L124">    }</span>

    @Override
    public void initialize() {
<span class="nc" id="L128">        initByType();</span>
<span class="nc" id="L129">    }</span>

    @Override
    public void restoreInstanceState(Bundle savedInstanceState) {
<span class="nc" id="L133">        otpMethod = savedInstanceState.getString(KEY_OTP_METHOD);</span>
<span class="nc" id="L134">        otpOrPassword = savedInstanceState.getString(KEY_OTP_OR_PASSWORD);</span>
<span class="nc" id="L135">        referenceId = savedInstanceState.getString(KEY_REFERENCE_ID);</span>
<span class="nc" id="L136">        captcha = savedInstanceState.getString(KEY_CAPTCHA);</span>
//        shouldShowCaptcha = savedInstanceState.getBoolean(KEY_SHOW_CAPTCHA, false);
<span class="nc" id="L138">        getPresenter().setPasswordErrorCount(savedInstanceState.getInt(KEY_PASSWORD_ERROR_COUNT));</span>
<span class="nc" id="L139">    }</span>

    @Override
    public void restoreView() {
<span class="nc" id="L143">        initByType();</span>
<span class="nc" id="L144">    }</span>

    @Override
    public void saveInstanceState(Bundle outState) {
<span class="nc" id="L148">        outState.putString(KEY_OTP_METHOD, otpMethod);</span>
<span class="nc" id="L149">        outState.putString(KEY_OTP_OR_PASSWORD, otpOrPassword);</span>
<span class="nc" id="L150">        outState.putString(KEY_REFERENCE_ID, referenceId);</span>
<span class="nc" id="L151">        outState.putString(KEY_CAPTCHA, captcha);</span>
//        outState.putBoolean(KEY_SHOW_CAPTCHA, shouldShowCaptcha);
<span class="nc" id="L153">        outState.putInt(KEY_PASSWORD_ERROR_COUNT, getPresenter().getPasswordErrorCount());</span>
<span class="nc" id="L154">    }</span>

    private void checkCaptcha() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (hasCaptcha()) {</span>
<span class="nc" id="L158">            showCaptcha();</span>
        } else {
<span class="nc" id="L160">            hideCaptcha();</span>
        }
<span class="nc" id="L162">    }</span>

    private void hideCaptcha() {
<span class="nc" id="L165">        layoutCaptcha.setVisibility(View.GONE);</span>
<span class="nc" id="L166">    }</span>

    private void showCaptcha() {
<span class="nc" id="L169">        animateFadeShow(layoutCaptcha);</span>
<span class="nc" id="L170">    }</span>

    private void initForOtp() {
<span class="nc" id="L173">        etPassword.setHint(getString(R.string.my_ais_login_password_otp_hint));</span>
<span class="nc" id="L174">        etPassword.setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_VARIATION_PASSWORD);</span>
<span class="nc" id="L175">        etPassword.setFilters(new InputFilter[]{new InputFilter.LengthFilter(4)});</span>
<span class="nc" id="L176">        etPassword.setTypeface(etMobileNumber.getTypeface());</span>
<span class="nc" id="L177">    }</span>

    private void initForSms() {
<span class="nc" id="L180">        initForOtp();</span>
<span class="nc" id="L181">        tvHint.setText(getString(R.string.my_ais_login_password_instruction_label_sms));</span>

<span class="nc" id="L183">    }</span>

    private void initForEmail() {
<span class="nc" id="L186">        initForOtp();</span>
<span class="nc" id="L187">        tvHint.setText(getString(R.string.my_ais_login_password_instruction_label_email));</span>
<span class="nc" id="L188">    }</span>

    private void initForPassword() {
<span class="nc" id="L191">        tvHint.setText(getString(R.string.my_ais_login_password_instruction_label_password));</span>
<span class="nc" id="L192">        etPassword.setHint(getString(R.string.my_ais_login_password_password_hint));</span>
<span class="nc" id="L193">        etPassword.setInputType(InputType.TYPE_CLASS_TEXT | InputType.TYPE_TEXT_VARIATION_PASSWORD);</span>
<span class="nc" id="L194">        etPassword.setFilters(new InputFilter[]{new InputFilter.LengthFilter(15)});</span>
<span class="nc" id="L195">        etPassword.setTypeface(etMobileNumber.getTypeface());</span>
<span class="nc" id="L196">        showForgotPasswordButton();</span>
<span class="nc" id="L197">    }</span>

    @NonNull
    private View.OnClickListener onCancelButtonClick() {
<span class="nc" id="L201">        return v -&gt; getActivity().onBackPressed();</span>
    }

    @NonNull
    private View.OnClickListener onOkButtonClick() {
<span class="nc" id="L206">        return v -&gt; {</span>
<span class="nc" id="L207">            String password = etPassword.getText().toString();</span>
<span class="nc" id="L208">            String captcha = etCaptcha.getText().toString();</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">            if (isSmsType() || isEmailType()) {</span>
<span class="nc" id="L210">                getPresenter().onSubmitOtpButtonClick(password, referenceId, hasCaptcha(), captcha);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            } else if (isPasswordType()) {</span>
<span class="nc" id="L212">                getPresenter().onSubmitPasswordButtonClick(Mobile.getInstance().getMobileNumber(), password, hasCaptcha(), captcha);</span>
            }
<span class="nc" id="L214">        };</span>
    }

    private boolean isPasswordType() {
<span class="nc" id="L218">        return otpOrPassword.equalsIgnoreCase(LoginKey.VERIFICATION_TYPE_PASSWORD);</span>
    }


    private boolean isEmailType() {
<span class="nc" id="L223">        return otpOrPassword.equalsIgnoreCase(LoginKey.VERIFICATION_TYPE_EMAIL);</span>
    }

    private boolean isSmsType() {
<span class="nc" id="L227">        return otpOrPassword.equalsIgnoreCase(LoginKey.VERIFICATION_TYPE_SMS);</span>
    }


    @Override
    public EditText getInjectEditText() {
<span class="nc" id="L233">        return etPassword;</span>
    }

    @Override
    public void showCaptchaEmpty() {
<span class="nc" id="L238">        showAlertDialogDismissOnClick(getString(R.string.my_ais_login_captcha_empty));</span>
<span class="nc" id="L239">    }</span>

    @Override
    public void showOtpEmpty() {
<span class="nc" id="L243">        showAlertDialogDismissOnClick(getString(R.string.my_ais_login_otp_empty));</span>
<span class="nc" id="L244">    }</span>

    @Override
    public void showOtpInvalid() {
<span class="nc" id="L248">        showAlertDialogDismissOnClick(getString(R.string.my_ais_login_incorrect_otp));</span>
<span class="nc" id="L249">    }</span>

    @Override
    public void showWrongOtp(String message) {
<span class="nc" id="L253">        showAlertDialogDismissOnClick(message);</span>
<span class="nc" id="L254">    }</span>

    @Override
    public void showWrong3Otp(String message) {
<span class="nc" id="L258">        showAlertDialogDismissOnClick(message);</span>
<span class="nc" id="L259">    }</span>

    @Override
    public void showWrong3Password() {
<span class="nc" id="L263">        getPresenter().sendGoToWelcomeEvent();</span>
<span class="nc" id="L264">        String message = getString(R.string.my_ais_login_incorrect_password_3_times);</span>
<span class="nc" id="L265">        showAlertDialogCustomOnClick(message, gotoForgetPassword());</span>
<span class="nc" id="L266">    }</span>

    @NonNull
    private SimpleDialogClickListener gotoForgetPassword() {
<span class="nc" id="L270">        return data -&gt; {</span>
<span class="nc" id="L271">            String mobileNumber = etMobileNumber.getText().toString();</span>
<span class="nc" id="L272">            Observable.empty()</span>
<span class="nc" id="L273">                    .delay(600, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L274">                    .doOnCompleted(() -&gt; getPresenter().sendGoToForgotPasswordEvent(mobileNumber))</span>
<span class="nc" id="L275">                    .subscribe();</span>
<span class="nc" id="L276">        };</span>
    }

    @Override
    public void setCaptchaImage(String captchaInBase64) {
<span class="nc" id="L281">        captcha = captchaInBase64;</span>
<span class="nc" id="L282">        showCaptcha();</span>
<span class="nc" id="L283">        etCaptcha.requestFocus();</span>
<span class="nc" id="L284">        ivCaptcha.setImageBitmap(NextzyBitmapUtility.decodeBase64Image(captchaInBase64));</span>
<span class="nc" id="L285">    }</span>

    @Override
    public void showPasswordInvalid() {
<span class="nc" id="L289">        showAlertDialogDismissOnClick(getString(R.string.my_ais_login_password_instruction_label_password));</span>
<span class="nc" id="L290">    }</span>

    @Override
    public void setAutoOtp(String otp) {
<span class="nc bnc" id="L294" title="All 4 branches missed.">        if (isVisible() &amp;&amp; isSmsType()) {</span>
<span class="nc" id="L295">            etPassword.setText(otp);</span>
        }
<span class="nc" id="L297">    }</span>

    @Override
    public void onForgetPasswordClick() {
<span class="nc" id="L301">        String accountNumber = etMobileNumber.getText().toString();</span>
<span class="nc" id="L302">        openForgotPassword(accountNumber);</span>
<span class="nc" id="L303">    }</span>

    private void openForgotPassword(String mobileNumber) {
<span class="nc" id="L306">        Bundle bundle = new Bundle();</span>
<span class="nc" id="L307">        bundle.putString(ForgotPasswordActivity.KEY_ACCOUNT_NUMBER, mobileNumber);</span>
<span class="nc" id="L308">        openActivity(ForgotPasswordActivity.class, bundle);</span>
<span class="nc" id="L309">    }</span>

    private boolean hasCaptcha() {
<span class="nc bnc" id="L312" title="All 4 branches missed.">        return captcha != null &amp;&amp; !captcha.isEmpty();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>