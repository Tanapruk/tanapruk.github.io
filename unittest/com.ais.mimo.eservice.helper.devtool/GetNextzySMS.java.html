<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GetNextzySMS.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ais.mimo.eservice.helper.devtool</a> &gt; <span class="el_source">GetNextzySMS.java</span></div><h1>GetNextzySMS.java</h1><pre class="source lang-java linenums">package com.ais.mimo.eservice.helper.devtool;

import com.google.gson.GsonBuilder;
import com.google.gson.annotations.SerializedName;
import com.nextzy.myais.common.BuildConfig;
import com.nextzy.myais.common.constant.URL;
import com.nextzy.myais.common.network.tool.NextzyHttpLogger;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.Locale;
import java.util.concurrent.TimeUnit;

import okhttp3.OkHttpClient;
import okhttp3.logging.HttpLoggingInterceptor;
import retrofit2.Retrofit;
import retrofit2.adapter.rxjava.RxJavaCallAdapterFactory;
import retrofit2.converter.gson.GsonConverterFactory;
import retrofit2.http.GET;
import rx.Single;
import rx.SingleSubscriber;
import rx.android.schedulers.AndroidSchedulers;
import rx.schedulers.Schedulers;

/**
 * Created by trusttanapruk on 10/2/2016.
 */

public class GetNextzySMS {
<span class="nc" id="L33">    private static String WAIT_FOR_OTP = &quot;Wait for OTP&quot;;</span>
    private List&lt;MobileModel&gt; mMobileModelList;
    private Automator automator;
    private Cycler cycler;
    private static String currentMobileNumber;

    public interface Cycler {
        void setMobileNumber(String mobileNumber);

        void alert(String comment);
    }

    public interface Automator {
        void setOtp(String otp);

        void alert(String alertMessage);
    }

    //get sms from this
<span class="nc" id="L52">    public GetNextzySMS(Automator view) {</span>
<span class="nc" id="L53">        automator = view;</span>
<span class="nc" id="L54">        initMobileModelList();</span>
<span class="nc" id="L55">        retrieveOtp();</span>
<span class="nc" id="L56">    }</span>

    //cycle sms through this constructor
<span class="nc" id="L59">    public GetNextzySMS(String currentNumber, Cycler cycler) {</span>
<span class="nc" id="L60">        this.cycler = cycler;</span>
<span class="nc" id="L61">        initMobileModelList();</span>
<span class="nc" id="L62">        setMobileNumberFromAllowedList(currentNumber);</span>
<span class="nc" id="L63">    }</span>

    private void initMobileModelList() {
<span class="nc" id="L66">        mMobileModelList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L67">        mMobileModelList.add(new MobileModel(&quot;0926621664&quot;, WAIT_FOR_OTP, &quot;Nextzy Postpaid&quot;));</span>
<span class="nc" id="L68">        mMobileModelList.add(new MobileModel(&quot;0624215298&quot;, WAIT_FOR_OTP, &quot;Nextzy Prepaid&quot;));</span>
<span class="nc" id="L69">        mMobileModelList.add(new MobileModel(&quot;0935853304&quot;, &quot;1234&quot;, &quot;AIS Prepaid Test&quot;));</span>
<span class="nc" id="L70">        mMobileModelList.add(new MobileModel(&quot;0872056565&quot;, WAIT_FOR_OTP, &quot;Nextzy Corp Postpaid&quot;));</span>
<span class="nc" id="L71">        mMobileModelList.add(new MobileModel(&quot;0884035121&quot;, WAIT_FOR_OTP, &quot;Bin Postpaid&quot;));</span>
<span class="nc" id="L72">        mMobileModelList.add(new MobileModel(&quot;8800035365&quot;, &quot;Test@2018&quot;, &quot;AIS Fibre Test&quot;));</span>
<span class="nc" id="L73">        mMobileModelList.add(new MobileModel(&quot;8800087538&quot;, &quot;P@ssw0rd&quot;, &quot;Akexorcist Fibre with Switch number&quot;));</span>
<span class="nc" id="L74">        mMobileModelList.add(new MobileModel(&quot;0629969829&quot;, &quot;Jatupatk@2&quot;, &quot;AIS Test&quot;));</span>
<span class="nc" id="L75">    }</span>


    private void retrieveOtp() {
<span class="nc" id="L79">        String otp = getStaticOtp();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (URL.isMock) {</span>
<span class="nc" id="L81">            automator.alert(&quot;This is a MOCK. Any number will work.&quot;);</span>
<span class="nc" id="L82">            automator.setOtp(&quot;9999&quot;);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        } else if (!otp.equals(WAIT_FOR_OTP)) {</span>
<span class="nc" id="L84">            automator.setOtp(otp);</span>
        } else {
<span class="nc" id="L86">            callServiceToSleepingForLess();</span>
        }
<span class="nc" id="L88">    }</span>

    private void callServiceToSleepingForLess() {
        //decided not to have a delay
<span class="nc" id="L92">        rx.Observable.empty()</span>
<span class="nc" id="L93">                .delay(0, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L94">                .doOnCompleted(this::getOtpFromSleepingForLess)</span>
<span class="nc" id="L95">                .subscribe();</span>
<span class="nc" id="L96">    }</span>

    private String getStaticOtp() {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (MobileModel mobileModel : mMobileModelList) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (mobileModel.getMobileNumber().equalsIgnoreCase(currentMobileNumber)) {</span>
<span class="nc" id="L101">                return mobileModel.getPassword();</span>
            }
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">        return &quot;&quot;;</span>
    }


    private void setMobileNumberFromAllowedList(String currentNumber) {
<span class="nc" id="L109">        MobileModel mobileModel = mMobileModelList.get(getNextMobileNumberIndex(currentNumber));</span>
<span class="nc" id="L110">        currentMobileNumber = mobileModel.getMobileNumber();</span>
<span class="nc" id="L111">        cycler.setMobileNumber(currentMobileNumber);</span>
<span class="nc" id="L112">        cycler.alert(mobileModel.getComment());</span>
<span class="nc" id="L113">    }</span>

    private int getNextMobileNumberIndex(String currentMobileNumber) {
<span class="nc" id="L116">        int index = -1;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (MobileModel mobileModel : mMobileModelList) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (mobileModel.getMobileNumber().equalsIgnoreCase(currentMobileNumber)) {</span>
<span class="nc" id="L119">                index = mMobileModelList.indexOf(mobileModel);</span>
            }
<span class="nc" id="L121">        }</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (index == -1) {</span>
<span class="nc" id="L124">            index = 0;</span>
        } else {
<span class="nc" id="L126">            index += 1;</span>
        }

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (index &gt; mMobileModelList.size() - 1) {</span>
<span class="nc" id="L130">            index = 0;</span>
        }
<span class="nc" id="L132">        return index;</span>
    }


    interface AkexorcistApi {
        @GET(&quot;/AutoSMS/getRecentOtpSms/&quot;)
        Single&lt;SleepingForLessAutoSmsResult&gt; getOtp();
    }


<span class="nc" id="L142">    private class SleepingForLessAutoSmsResult {</span>
        @SerializedName(&quot;otp_list&quot;)
        List&lt;OtpChunk&gt; mOtpChunkList;

<span class="nc" id="L146">        public class OtpChunk {</span>
            private int _id;
            private String mobile_number;
            private String otp;
            private String timestamp;

            public int get_id() {
<span class="nc" id="L153">                return _id;</span>
            }

            public String getMobile_number() {
<span class="nc" id="L157">                return mobile_number;</span>
            }

            String getOtp() {
<span class="nc" id="L161">                return otp;</span>
            }

            public String getTimestamp() {
<span class="nc" id="L165">                return timestamp;</span>
            }

            public Calendar getCalendar() {
<span class="nc" id="L169">                Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L170">                String TIMESTAMP_FORMAT = &quot;dd MMM yyyy - HH:mm:ss&quot;;</span>
<span class="nc" id="L171">                SimpleDateFormat sdf = new SimpleDateFormat(TIMESTAMP_FORMAT, Locale.US);</span>
                try {
<span class="nc" id="L173">                    calendar.setTime(sdf.parse(timestamp));</span>
<span class="nc" id="L174">                } catch (ParseException e) {</span>
<span class="nc" id="L175">                    e.printStackTrace();</span>
<span class="nc" id="L176">                }</span>
<span class="nc" id="L177">                return calendar;</span>
            }
        }
    }

    private class MobileModel {
        String mobileNumber;
        String password;
        String comment;

<span class="nc" id="L187">        public MobileModel(String mobileNumber, String password, String comment) {</span>
<span class="nc" id="L188">            this.mobileNumber = mobileNumber;</span>
<span class="nc" id="L189">            this.password = password;</span>
<span class="nc" id="L190">            this.comment = comment;</span>
<span class="nc" id="L191">        }</span>

        public String getMobileNumber() {
<span class="nc" id="L194">            return mobileNumber;</span>
        }

        public void setMobileNumber(String mobileNumber) {
<span class="nc" id="L198">            this.mobileNumber = mobileNumber;</span>
<span class="nc" id="L199">        }</span>

        public String getPassword() {
<span class="nc" id="L202">            return password;</span>
        }

        public void setPassword(String password) {
<span class="nc" id="L206">            this.password = password;</span>
<span class="nc" id="L207">        }</span>

        public String getComment() {
<span class="nc" id="L210">            return comment;</span>
        }

        public void setComment(String comment) {
<span class="nc" id="L214">            this.comment = comment;</span>
<span class="nc" id="L215">        }</span>
    }


    public void getOtpFromSleepingForLess() {

<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (!BuildConfig.DEBUG) {</span>
<span class="nc" id="L222">            return;</span>
        }

<span class="nc" id="L225">        OkHttpClient okHttpClient = new OkHttpClient.Builder()</span>
<span class="nc" id="L226">                .addNetworkInterceptor(new HttpLoggingInterceptor(new NextzyHttpLogger()).setLevel(HttpLoggingInterceptor.Level.BODY))</span>
<span class="nc" id="L227">                .build();</span>

<span class="nc" id="L229">        Retrofit retrofit = new Retrofit.Builder()</span>
<span class="nc" id="L230">                .client(okHttpClient)</span>
<span class="nc" id="L231">                .addConverterFactory(GsonConverterFactory.create(new GsonBuilder().setPrettyPrinting().create()))</span>
<span class="nc" id="L232">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span>
<span class="nc" id="L233">                .baseUrl(&quot;http://sleepingforless.com:2082/&quot;)</span>
<span class="nc" id="L234">                .build();</span>

<span class="nc" id="L236">        retrofit.create(AkexorcistApi.class).getOtp()</span>
<span class="nc" id="L237">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L238">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L239">                .subscribe(new SingleSubscriber&lt;SleepingForLessAutoSmsResult&gt;() {</span>
                    @Override
                    public void onSuccess(SleepingForLessAutoSmsResult value) {

<span class="nc bnc" id="L243" title="All 2 branches missed.">                        for (SleepingForLessAutoSmsResult.OtpChunk chuck : value.mOtpChunkList) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                            if (!chuck.getMobile_number().equalsIgnoreCase(currentMobileNumber)) {</span>
<span class="nc" id="L245">                                continue;</span>
                            }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                            if (Calendar.getInstance().getTimeInMillis() - chuck.getCalendar().getTimeInMillis() &gt; 120000) {</span>
<span class="nc" id="L248">                                automator.alert(&quot;This Otp has been here more that 2 minutes. It may be expired. Smash GET OTP again!&quot;);</span>
                            } else {
<span class="nc" id="L250">                                automator.alert(&quot;This Otp is ok&quot;);</span>
                            }

<span class="nc" id="L253">                            automator.setOtp(chuck.getOtp());</span>
<span class="nc" id="L254">                            break;</span>
                        }
<span class="nc" id="L256">                    }</span>

                    @Override
                    public void onError(Throwable error) {
<span class="nc" id="L260">                        automator.alert(&quot;Something wrong do nothing&quot;);</span>
<span class="nc" id="L261">                        automator.setOtp(&quot;&quot;);</span>
<span class="nc" id="L262">                        error.printStackTrace();</span>
<span class="nc" id="L263">                    }</span>
                });
<span class="nc" id="L265">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>