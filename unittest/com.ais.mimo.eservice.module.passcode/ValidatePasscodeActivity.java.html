<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidatePasscodeActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ais.mimo.eservice.module.passcode</a> &gt; <span class="el_source">ValidatePasscodeActivity.java</span></div><h1>ValidatePasscodeActivity.java</h1><pre class="source lang-java linenums">package com.ais.mimo.eservice.module.passcode;

import android.content.Intent;
import android.os.Bundle;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;

import com.ais.mimo.eservice.module.login.activity.LoginActivity;
import com.nextzy.myais.common.mvp.NextzyMvpActivity;
import com.nextzy.myais.common.network.tool.NextzyWebkitCookieJar;
import com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager;
import com.nextzy.myais.common.utility.DataUpdatePreference;
import com.nextzy.myais.common.utility.DefaultPreference;
import com.nextzy.myais.common.widget.AISTextView;
import com.nextzy.myais.common.widget.dialog.AisDialog;
import com.nextzy.myais.common.widget.dialog.listener.ChoiceDialogClickListener;
import com.nextzy.myais.myais.R;

import th.co.thekhaeng.pinlock.IndicatorDots;
import th.co.thekhaeng.pinlock.LeftButtonClickListener;
import th.co.thekhaeng.pinlock.PinLockListener;
import th.co.thekhaeng.pinlock.PinLockView;
import timber.log.Timber;

import static com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager.ERROR_FINGERPRINT_5_TIMES;
import static com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager.ERROR_FINGERPRINT_ERROR_HELP;
import static com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager.ERROR_FINGERPRINT_NOT_RECOGNIZED;
import static com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager.ERROR_FINGERPRINT_NOT_SUPPORTED;
import static com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager.ERROR_FINGERPRINT_PERMISSION_DENIED;
import static com.nextzy.myais.common.passcode.manager.NextzyFingerprintManager.ERROR_FINGERPRINT_REGISTRATION_NEEDED;
import static com.nextzy.myais.common.utility.DefaultPreference.KEY_MASTER_NUMBER;
import static com.nextzy.myais.common.utility.DefaultPreference.KEY_PRIVATE_ID;
import static com.nextzy.myais.common.utility.DefaultPreference.KEY_TOKEN;

public class ValidatePasscodeActivity extends NextzyMvpActivity&lt;ValidatePasscodeContractor.Presenter&gt;
        implements ValidatePasscodeContractor.View {
    private static final int MAX_ERROR_COUNT = 3;
    public static final String KEY_PASSCODE_FOR_VALIDATE = &quot;key_passcode_for_confirm&quot;;
    public static final int RESULT_MATCH_PASSCODE = 10;
    public static final int PIN_LENGTH = 6;
    public static final String KEY_CANCEL_TOUCH_ID = &quot;key_cancel_touch_id&quot;;
    private IndicatorDots indicatorDots;
    private PinLockView pinLockView;
    private AISTextView tvPasscodeTitle;
    private DefaultPreference preference;
    private String myPasscode;
    private String myMasterNumber;
    private String myPrivateId;
    private String myToken;
    private NextzyFingerprintManager fingerPrintManager;
    private AISTextView tvCancel;
    private int errorCount;
    private boolean isCancelTouchId = false;

    @Override
    protected void createPresenter() {
        ValidatePasscodePresenter.createPresenter(this);
        Bundle extra = getIntent().getExtras();
        checkMyPasscode(extra);
        preference = DefaultPreference.getInstance();
        fingerPrintManager = NextzyFingerprintManager.getInstance();
    }

    private void checkMyPasscode(Bundle extra) {
        if (extra != null) {
            myPasscode = extra.getString(KEY_PASSCODE_FOR_VALIDATE);
            myMasterNumber = extra.getString(KEY_MASTER_NUMBER);
            myPrivateId = extra.getString(KEY_PRIVATE_ID);
            myToken = extra.getString(KEY_TOKEN);
            if (myMasterNumber == null)
                throw new NullPointerException(&quot;You must send KEY_MASTER_NUMBER to this activity&quot;);
            if (myPasscode == null)
                throw new NullPointerException(&quot;You must send KEY_PASSCODE_FOR_VALIDATE to this activity&quot;);
            if (myPrivateId == null)
                throw new NullPointerException(&quot;You must send KEY_PRIVATE_ID to this activity&quot;);
            if (myToken == null)
                throw new NullPointerException(&quot;You must send KEY_TOKEN to this activity&quot;);
        } else {
            throw new NullPointerException(&quot;You must send Extra bundle to this activity.&quot;);
        }
    }


    @Override
    public int getLayoutView() {
        return R.layout.my_ais_library_passcode_confirm_activity;
    }


    @Override
    public void bindView() {
        tvPasscodeTitle = (AISTextView) findViewById(R.id.my_ais_pinlock_tv_title);
        indicatorDots = (IndicatorDots) findViewById(R.id.my_ais_pinlock_indicator_dots);
        pinLockView = (PinLockView) findViewById(R.id.my_ais_pinlock_view);
        tvCancel = (AISTextView) findViewById(R.id.my_ais_tv_cancel_passcode);
    }

    @Override
    public void setupView() {
        tvPasscodeTitle.setText(getString(R.string.my_ais_passcode_title_enter_passcode));
        pinLockView.attachIndicatorDots(indicatorDots);
        pinLockView.setPinLockListener(onPinLockListener());
        pinLockView.setOnClickButtonLeftListener(createLeftButtonListener());
        pinLockView.setPinLength(PIN_LENGTH);

        fingerPrintManager.init(this, onFingerListener());
        tvCancel.setOnClickListener(v -&gt; clickCancel());
    }


    @Override
    public void initialize() {

    }


    @Override
    public void restoreArgument(Bundle bundle) {
    }

    @Override
    public void restoreView() {

    }

    @Override
    public void saveInstanceState(Bundle outState) {
        outState.putBoolean(KEY_CANCEL_TOUCH_ID, isCancelTouchId);
    }

    @Override
    public void restoreInstanceState(Bundle savedInstanceState) {
        isCancelTouchId = savedInstanceState.getBoolean(KEY_CANCEL_TOUCH_ID, false);
    }

    @Override
    public void showResponseException(String message) {
        showAlertDialogDismissOnClick(message);
    }

    @Override
    public void goToLoginActivity() {
        DataUpdatePreference.getInstance().clear(this);
        NextzyWebkitCookieJar.getInstance().clearCookie(this);
        Bundle bundle = new Bundle();
        bundle.putBoolean(LoginActivity.SHOULD_BYPASS, false);
        openActivity(LoginActivity.class, bundle, true, true);
    }

    @Override
    public void removePasscodeAndMasterNumberAndPrivateIdAndToken() {
        preference.removeAllPasscodeData();
    }


    private void clickCancel() {
        onBackPressed();
    }

    private void clickForgot() {
        AisDialog.getInstance().showChoiceDialog(getSupportFragmentManager(),
                null,
                getString(R.string.my_ais_passcode_dialog_forgot),
                getString(R.string.ok),
                getString(R.string.cancel),
<span class="nc" id="L166">                new ChoiceDialogClickListener() {</span>
                    @Override
                    public void onDialogPositiveButtonClick(@Nullable Bundle data) {
<span class="nc" id="L169">                        dismissDialog();</span>
<span class="nc" id="L170">                        showLoadingDialog();</span>
<span class="nc" id="L171">                        getPresenter().requestDisableFingerScanAndGoToLoginFragment(</span>
<span class="nc" id="L172">                                myMasterNumber,</span>
<span class="nc" id="L173">                                myPrivateId,</span>
<span class="nc" id="L174">                                myToken,</span>
                                false
                        );
<span class="nc" id="L177">                    }</span>

                    @Override
                    public void onDialogNegativeButtonClick(@Nullable Bundle data) {
<span class="nc" id="L181">                        dismissDialog();</span>
<span class="nc" id="L182">                    }</span>
                });
    }

    private void finishConfirmPasscode() {
        Intent returnIntent = new Intent();
        setResult(RESULT_MATCH_PASSCODE, returnIntent);
        finish();
    }


    private void setReEnterPasscode() {
        pinLockView.animateNotMatchPasscodeAndClearIndicator();
        tvPasscodeTitle.setText(getString(R.string.my_ais_passcode_title_enter_passcode));
    }

    private void showTouchIdDialog() {
        AisDialog.getInstance().showSimpleNegativeDialog(
                getSupportFragmentManager(),
                R.drawable.my_ais_library_ic_fingerprint,
                null,
                getString(R.string.my_ais_login_touch_id_message),
                getString(R.string.cancel),
                false,
                data -&gt; {
                    isCancelTouchId = true;
                    fingerPrintManager.stop();
                });
    }

    private void showTouchIdCannotAuthenticationDialog() {
        AisDialog.getInstance().showSimpleNegativeDialog(
                getSupportFragmentManager(),
                R.drawable.my_ais_library_ic_fingerprint,
                getString(R.string.my_ais_login_touch_id_try_again),
                getString(R.string.my_ais_login_touch_id_cannot_authentication),
                getString(R.string.cancel),
                false,
                data -&gt; fingerPrintManager.stop());
    }

    private void showMaximumPasscodeLimitDialog() {
        AisDialog.getInstance().showSimpleDialog(getSupportFragmentManager(),
                null,
                getString(R.string.my_ais_passcode_message_maximum_invalidate),
                getString(R.string.ok), data -&gt;
                        getPresenter().requestDisableFingerScanAndGoToLoginFragment(
                                myMasterNumber,
                                myPrivateId,
                                myToken,
                                false
                        ));
    }

    @NonNull
    private LeftButtonClickListener createLeftButtonListener() {
        return numberViewHolder -&gt; clickForgot();
    }

    @NonNull
    private PinLockListener onPinLockListener() {
<span class="nc" id="L243">        return new PinLockListener() {</span>

            @Override
            public void onComplete(String putPasscode) {
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (putPasscode.equals(myPasscode)) {</span>
<span class="nc" id="L248">                    finishConfirmPasscode();</span>
                } else {
<span class="nc" id="L250">                    setReEnterPasscode();</span>
                }

<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (putPasscode.equals(myPasscode)) {</span>
<span class="nc" id="L254">                    finishConfirmPasscode();</span>
                } else {
<span class="nc" id="L256">                    setReEnterPasscode();</span>
<span class="nc" id="L257">                    errorCount += 1;</span>
                }

<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (errorCount &gt;= MAX_ERROR_COUNT) {</span>
<span class="nc" id="L261">                    showMaximumPasscodeLimitDialog();</span>
<span class="nc" id="L262">                    pinLockView.clearIndicator();</span>
                }
<span class="nc" id="L264">            }</span>

            @Override
            public void onEmpty() {
<span class="nc" id="L268">                Timber.i(&quot;Pin empty&quot;);</span>
<span class="nc" id="L269">            }</span>

            @Override
            public void onPinChange(int pinLength, String intermediatePin) {
<span class="nc" id="L273">                Timber.i(&quot;Pin changed, new length &quot; + pinLength + &quot; with intermediate pin &quot; + intermediatePin);</span>
<span class="nc" id="L274">            }</span>
        };
    }

    @NonNull
    private NextzyFingerprintManager.OnFingerprintResultCallback onFingerListener() {
<span class="nc" id="L280">        return new NextzyFingerprintManager.OnFingerprintResultCallback() {</span>
<span class="nc" id="L281">            boolean isErrorFirst = false;</span>

            @Override
            public void onFingerprintAuthenticationSuccess() {
<span class="nc" id="L285">                Timber.i(&quot;onFingerprintAuthenticationSuccess: &quot;);</span>
<span class="nc" id="L286">                dismissDialog();</span>
<span class="nc" id="L287">                finishConfirmPasscode();</span>
<span class="nc" id="L288">            }</span>

            @Override
            public void onFingerprintAuthenticationError(int errorType, Exception exception) {
<span class="nc" id="L292">                Timber.i(&quot;onFingerprintAuthenticationError: errorType=&quot; + errorType + &quot; exception=&quot; + exception.getMessage());</span>
<span class="nc bnc" id="L293" title="All 7 branches missed.">                switch (errorType) {</span>
                    case ERROR_FINGERPRINT_NOT_SUPPORTED:
<span class="nc" id="L295">                        break;</span>
                    case ERROR_FINGERPRINT_NOT_RECOGNIZED:
<span class="nc bnc" id="L297" title="All 2 branches missed.">                        if (!isErrorFirst) {</span>
<span class="nc" id="L298">                            isErrorFirst = true;</span>
<span class="nc" id="L299">                            showTouchIdCannotAuthenticationDialog();</span>
                        }
                        break;
                    case ERROR_FINGERPRINT_PERMISSION_DENIED:
<span class="nc" id="L303">                        break;</span>
                    case ERROR_FINGERPRINT_REGISTRATION_NEEDED:
<span class="nc" id="L305">                        break;</span>
                    case ERROR_FINGERPRINT_ERROR_HELP:
<span class="nc" id="L307">                        break;</span>
                    case ERROR_FINGERPRINT_5_TIMES:
<span class="nc" id="L309">                        fingerPrintManager.stop();</span>
<span class="nc" id="L310">                        dismissDialog();</span>
                        break;
                }
<span class="nc" id="L313">            }</span>

            @Override
            public void onFingerprintAuthenticationReady() {
<span class="nc" id="L317">                Timber.i(&quot;onFingerprintAuthenticationReady: &quot;);</span>
<span class="nc" id="L318">                isErrorFirst = false;</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">                if (preference.loadTouchIdSwitchSetting() &amp;&amp; !isCancelTouchId) {</span>
<span class="nc" id="L320">                    fingerPrintManager.start();</span>
                } else {
<span class="nc" id="L322">                    fingerPrintManager.stop();</span>
                }
<span class="nc" id="L324">            }</span>

            @Override
            public void onFingerprintAuthenticationScanning(boolean invalidKey) {
<span class="nc" id="L328">                Timber.i(&quot;onFingerprintAuthenticationScanning: invalidKey=&quot; + invalidKey);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if (!isShowAisAlertDialog()) {</span>
<span class="nc" id="L330">                    showTouchIdDialog();</span>
                }
<span class="nc" id="L332">            }</span>
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>