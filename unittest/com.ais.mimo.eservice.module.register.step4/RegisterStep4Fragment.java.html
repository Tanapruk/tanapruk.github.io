<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegisterStep4Fragment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.ais.mimo.eservice.module.register.step4</a> &gt; <span class="el_source">RegisterStep4Fragment.java</span></div><h1>RegisterStep4Fragment.java</h1><pre class="source lang-java linenums">package com.ais.mimo.eservice.module.register.step4;

import android.content.Intent;
import android.os.Bundle;
import android.view.View;

import com.ais.mimo.eservice.helper.login.network.response.MobileData;
import com.ais.mimo.eservice.helper.register.network.response.RegisterMyNumberResult;
import com.ais.mimo.eservice.module.register.base.RegisterBaseFragment;
import com.ais.mimo.eservice.module.register.step4.addmobilenumber.acitivity.RegisterAddMobileNumberActivity;
import com.ais.mimo.eservice.module.register.step4.addmobilenumber.adapter.RegisterMobileNumberWithRequestOtpAdapter;
import com.ais.mimo.eservice.module.register.step4.addmobilenumber.adapter.holder.MobileRequestWithRequestOtpItemHolder;
import com.ais.mimo.eservice.module.register.utility.RegisterConverterUtility;
import com.ais.mimo.eservice.module.register.utility.model.MobileTypeGroup;
import com.ais.mimo.eservice.module.register.widget.MyAisRegisterMobileAccountView;
import com.nextzy.myais.common.constant.BusinessType;
import com.nextzy.myais.common.database.NextzyDatabase;
import com.nextzy.myais.common.mvp.NextzyMvpActivity;
import com.nextzy.myais.common.widget.AISButton;
import com.nextzy.myais.common.widget.AISTextView;
import com.nextzy.myais.myais.R;

import java.util.ArrayList;

import javax.annotation.Nullable;

import static android.app.Activity.RESULT_OK;
import static com.ais.mimo.eservice.helper.register.network.RegisterManager.SERVICE_GET_MY_NUMBER;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.EXTRA_DATA_ADD_MOBILE_NUMBER;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.KEY_CONFIRM_FBB_LIST_FOR_CHECK_USED;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.KEY_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.KEY_CONFIRM_PREPAID_LIST_FOR_CHECK_USED;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.KEY_NO_CONFIRM_FBB_LIST_FOR_CHECK_USED;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.KEY_NO_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberFragment.KEY_NO_CONFIRM_PREPAID_LIST_FOR_CHECK_USED;
import static com.ais.mimo.eservice.module.register.step4.addmobilenumber.fragment.RegisterAddMobileNumberPresenter.KEY_GROUP_FOCUS;
import static com.ais.mimo.eservice.module.register.widget.MyAisRegisterMobileAccountView.LINEAR_LAYOUT_MANAGER;
import static com.nextzy.myais.common.delegate.FormatUtility.FORMAT_MOBILE_NUMBER;


public class RegisterStep4Fragment extends RegisterBaseFragment&lt;RegisterStep4Contractor.Presenter&gt; implements RegisterStep4Contractor.View {
    public final static String TAG = RegisterStep4Fragment.class.getSimpleName();
    private static final int START_ADD_MOBILE = 100;
    public static final String EXTRA_DATA = &quot;extra_data&quot;;
    private MyAisRegisterMobileAccountView vMobileAccounts;
    private RegisterMobileNumberWithRequestOtpAdapter postAdapter;
    private RegisterMobileNumberWithRequestOtpAdapter preAdapter;
    private RegisterMobileNumberWithRequestOtpAdapter fbbAdapter;
    private AISTextView tvMobileNumber;
    private MobileRequestWithRequestOtpItemHolder focusViewHolder;
    private AISButton btnOk;
    private AISButton btnBack;

    public RegisterStep4Fragment() {
        super();
    }

    public static RegisterStep4Fragment newInstance(Bundle data) {
        RegisterStep4Fragment fragment = new RegisterStep4Fragment();
        fragment.setArguments(data);
        return fragment;
    }

    /*************************/
    /** Fragment life cycle **/
    /*************************/
    //&lt;editor-fold desc=&quot;Life cycle folding&quot;&gt;

    /**
     * onCreate()
     **/
    @Override
    protected void createPresenter() {
        RegisterStep4Presenter.createPresenter(this);
    }

    @Override
    public void restoreArgument(Bundle bundle) {

    }

    /**
     * onViewCreated()
     **/
    @Override
    public void bindView(View view) {
        vMobileAccounts = (MyAisRegisterMobileAccountView) view.findViewById(R.id.my_ais_regis_mobile_accounts);
        tvMobileNumber = (AISTextView) view.findViewById(R.id.my_ais_register_tv_mobile_number);

        btnOk = (AISButton) view.findViewById(R.id.my_ais_register_btn_ok);
        btnBack = (AISButton) view.findViewById(R.id.my_ais_register_btn_back);
    }

    @Override
    public void setupView() {
        setIndexIndicator(3);
        setBackgroundLightGray();
        String mobileNumber = getArgumentsStringMobileNumber();
        tvMobileNumber.setText(mobileNumber, FORMAT_MOBILE_NUMBER);
        btnBack.setOnClickListener(v -&gt;
                clickCancel());
        btnOk.setOnClickListener(v -&gt; clickNext());
        vMobileAccounts.setCanShowTitle(true);
        vMobileAccounts.setOnClickAddListener(v -&gt; clickAdd());
        vMobileAccounts.setLayoutManager(LINEAR_LAYOUT_MANAGER);
    }


    @Override
    public void initialize() {
        RegisterMyNumberResult myNumberResponse = NextzyDatabase.getInstance().findByName(
                SERVICE_GET_MY_NUMBER,
                RegisterMyNumberResult.class
        );
        MobileTypeGroup group = RegisterConverterUtility.getInstance().groupMobileNumberByType(
                myNumberResponse.getDataList()
        );
        getPresenter().setMobileGroupUi(
                group.getPostpaidList(),
                group.getFbbList(),
                group.getPrepaidList()
        );

    }


    @Override
    public void restoreView() {
        updateMobileAccountView( postAdapter, preAdapter, fbbAdapter );
    }

    /**
     * onCreateView
     **/
    @Override
    public int getLayoutView() {
        return R.layout.my_ais_register_fragment_step4;
    }


    /**
     * State
     **/
    @Override
    public void saveInstanceState(Bundle outState) {
        // Save Instance State here
        outState.putString(KEY_GROUP_FOCUS, getPresenter().getFocusBusinessType());
        outState.putParcelableArrayList(KEY_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED, postAdapter.getConfirmMobileList());
        outState.putParcelableArrayList(KEY_NO_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED, postAdapter.getNoConfirmMobileList());
        outState.putParcelableArrayList(KEY_CONFIRM_PREPAID_LIST_FOR_CHECK_USED, preAdapter.getConfirmMobileList());
        outState.putParcelableArrayList(KEY_NO_CONFIRM_PREPAID_LIST_FOR_CHECK_USED, preAdapter.getNoConfirmMobileList());
        outState.putParcelableArrayList(KEY_CONFIRM_FBB_LIST_FOR_CHECK_USED, fbbAdapter.getConfirmMobileList());
        outState.putParcelableArrayList(KEY_NO_CONFIRM_FBB_LIST_FOR_CHECK_USED, fbbAdapter.getNoConfirmMobileList());
    }

    @Override
    public void restoreInstanceState(Bundle savedInstanceState) {
        // Restore instance state here
        String restoreGroupFocus = savedInstanceState.getString(KEY_GROUP_FOCUS);
        getPresenter().setFocusBusinessType(restoreGroupFocus);

        postAdapter = new RegisterMobileNumberWithRequestOtpAdapter(
                savedInstanceState.getParcelableArrayList(KEY_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED),
                savedInstanceState.getParcelableArrayList(KEY_NO_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED)
        );
        preAdapter = new RegisterMobileNumberWithRequestOtpAdapter(
                savedInstanceState.getParcelableArrayList(KEY_CONFIRM_PREPAID_LIST_FOR_CHECK_USED),
                savedInstanceState.getParcelableArrayList(KEY_NO_CONFIRM_PREPAID_LIST_FOR_CHECK_USED)
        );
        fbbAdapter = new RegisterMobileNumberWithRequestOtpAdapter(
                savedInstanceState.getParcelableArrayList(KEY_CONFIRM_FBB_LIST_FOR_CHECK_USED),
                savedInstanceState.getParcelableArrayList(KEY_NO_CONFIRM_FBB_LIST_FOR_CHECK_USED)
        );
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == START_ADD_MOBILE) {
            if (resultCode == RESULT_OK) {
                Bundle bundle = data.getBundleExtra(EXTRA_DATA_ADD_MOBILE_NUMBER);

                ArrayList&lt;MobileData&gt; confirmPost =
                        bundle.getParcelableArrayList(KEY_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED);
                ArrayList&lt;MobileData&gt; confirmPre =
                        bundle.getParcelableArrayList(KEY_CONFIRM_PREPAID_LIST_FOR_CHECK_USED);
                ArrayList&lt;MobileData&gt; confirmFbb =
                        bundle.getParcelableArrayList(KEY_CONFIRM_FBB_LIST_FOR_CHECK_USED);
                postAdapter.markConfirmMobileNumberByList(confirmPost);
                preAdapter.markConfirmMobileNumberByList(confirmPre);
                fbbAdapter.markConfirmMobileNumberByList(confirmFbb);
                vMobileAccounts.notifyDataSetChanged();
                getPresenter().hideAddBtnIfCan();
            }
        }
    }

    //&lt;/editor-fold&gt;


    @Override
    public void hideAddBtn() {
        vMobileAccounts.hideAddButton();
    }

    @Override
    public void showAddBtn() {
        vMobileAccounts.showAddButton();
    }

    @Override
    public void setMobileDataListToAdapter(
            @Nullable ArrayList&lt;MobileData&gt; markConfirmPost,
            @Nullable ArrayList&lt;MobileData&gt; markConfirmPre,
            @Nullable ArrayList&lt;MobileData&gt; markConfirmFbb,
            @Nullable ArrayList&lt;MobileData&gt; noConfirmPost,
            @Nullable ArrayList&lt;MobileData&gt; noConfirmPre,
            @Nullable ArrayList&lt;MobileData&gt; noConfirmFbb) {
        postAdapter = new RegisterMobileNumberWithRequestOtpAdapter(markConfirmPost, noConfirmPost);
        preAdapter = new RegisterMobileNumberWithRequestOtpAdapter(markConfirmPre, noConfirmPre);
        fbbAdapter = new RegisterMobileNumberWithRequestOtpAdapter(markConfirmFbb, noConfirmFbb);
        updateMobileAccountView(postAdapter, preAdapter, fbbAdapter);

    }

    private void updateMobileAccountView(
            RegisterMobileNumberWithRequestOtpAdapter postAdapter,
            RegisterMobileNumberWithRequestOtpAdapter preAdapter,
            RegisterMobileNumberWithRequestOtpAdapter fbbAdapter) {
        postAdapter.setListener(postAdapterListener);
        preAdapter.setListener(preAdapterListener);
        fbbAdapter.setListener(fbbAdapterListener);

        vMobileAccounts.setPostAdapter(postAdapter);
        vMobileAccounts.setPreAdapter(preAdapter);
        vMobileAccounts.setFbbAdapter(fbbAdapter);
        getPresenter().hideAddBtnIfCan();
    }

    @Override
    public void launchAddMobileNumberActivity(
            ArrayList&lt;MobileData&gt; markConfirmPostList,
            ArrayList&lt;MobileData&gt; markConfirmPreList,
            ArrayList&lt;MobileData&gt; markConfirmFbbList,
            ArrayList&lt;MobileData&gt; noConfirmPost,
            ArrayList&lt;MobileData&gt; noConfirmPre,
            ArrayList&lt;MobileData&gt; noConfirmFbb) {

        Intent i = new Intent(getActivity(), RegisterAddMobileNumberActivity.class);
        Bundle data = getArguments();
        data.putParcelableArrayList(KEY_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED, markConfirmPostList);
        data.putParcelableArrayList(KEY_NO_CONFIRM_POSTPAID_LIST_FOR_CHECK_USED, noConfirmPost);
        data.putParcelableArrayList(KEY_CONFIRM_PREPAID_LIST_FOR_CHECK_USED, markConfirmPreList);
        data.putParcelableArrayList(KEY_NO_CONFIRM_PREPAID_LIST_FOR_CHECK_USED, noConfirmPre);
        data.putParcelableArrayList(KEY_CONFIRM_FBB_LIST_FOR_CHECK_USED, markConfirmFbbList);
        data.putParcelableArrayList(KEY_NO_CONFIRM_FBB_LIST_FOR_CHECK_USED, noConfirmFbb);
        i.putExtra(EXTRA_DATA, data);
        startActivityForResult(i, START_ADD_MOBILE);
    }

    @Override
    public void showDefaultOtpEdt() {
        if (focusViewHolder != null) {
            focusViewHolder.showDefaultEdt();
        }
    }

    @Override
    public void showDialogErrorOtpEdt() {
        if (focusViewHolder != null) {
            focusViewHolder.showErrorCaptchaEdt();
            String error;
            if (focusViewHolder.getOtp().isEmpty()) {
                error = getString(R.string.my_ais_register_dialog_otp_none);
            } else {
                error = getString(R.string.my_ais_register_dialog_otp_fault);
            }
            focusViewHolder.emptyOtp();
            ((NextzyMvpActivity) getActivity())
                    .showAlertDialogDismissOnClick(error);
        }
    }

    @Override
    public void showPostpaidLimitError(int limit) {
        String error = String.format(
                getString(R.string.my_ais_register_dialog_limit_postpaid),
                limit);
        ((NextzyMvpActivity) getActivity())
                .showAlertDialogDismissOnClick(error);
    }

    @Override
    public void showPrepaidLimitError(int limit) {
        String error = String.format(
                getString(R.string.my_ais_register_dialog_limit_prepaid),
                limit);
        ((NextzyMvpActivity) getActivity())
                .showAlertDialogDismissOnClick(error);
    }

    @Override
    public void showFbbLimitError(int limit) {
        String error = String.format(
                getString(R.string.my_ais_register_dialog_limit_fbb),
                limit);
        ((NextzyMvpActivity) getActivity())
                .showAlertDialogDismissOnClick(error);
    }

    @Override
    public void markConfirmCurrentMobileNumberPrepaid() {
        preAdapter.markConfirmCurrentMobileNumber();
    }

    @Override
    public void markConfirmCurrentMobileNumberPostpaid() {
        postAdapter.markConfirmCurrentMobileNumber();
    }

    @Override
    public void markConfirmCurrentMobileNumberFbb() {
        fbbAdapter.markConfirmCurrentMobileNumber();
    }

    @Override
    public int getMarkConfirmItemCountPostpaid() {
        return postAdapter.getMarkConfirmItemCount();
    }

    @Override
    public int getMarkConfirmItemCountPrepaid() {
        return preAdapter.getMarkConfirmItemCount();
    }

    @Override
    public int getMarkConfirmItemCountFbb() {
        return fbbAdapter.getMarkConfirmItemCount();
    }

    @Override
    public void setPostpaidClickRequestOtpAtFocusView() {
        if (focusViewHolder != null) {
            postAdapter.clickRequestOtpAt(focusViewHolder.getPos());
            fbbAdapter.setNoClickAll();
            preAdapter.setNoClickAll();
        }
    }

    @Override
    public void setFbbClickRequestOtpAtFocusView() {
        if (focusViewHolder != null) {
            postAdapter.setNoClickAll();
            fbbAdapter.clickRequestOtpAt(focusViewHolder.getPos());
            preAdapter.setNoClickAll();
        }
    }

    @Override
    public void setPrepaidClickRequestOtpAtFocusView() {
        if (focusViewHolder != null) {
            postAdapter.setNoClickAll();
            fbbAdapter.setNoClickAll();
            preAdapter.clickRequestOtpAt(focusViewHolder.getPos());
        }
    }

    /*************************/
    /** CallBack &amp; Listener **/
    /*************************/
    //&lt;editor-fold desc=&quot;CallBack &amp; Listener folding&quot;&gt;
<span class="nc" id="L372">    private MobileRequestWithRequestOtpItemHolder.OnClickItemListener postAdapterListener = new MobileRequestWithRequestOtpItemHolder.OnClickItemListener() {</span>
        @Override
        public void onClick(MobileRequestWithRequestOtpItemHolder h, View v, String mobileNumber, String otp, int pos) {
<span class="nc bnc" id="L375" title="All 3 branches missed.">            switch (v.getId()) {</span>
                case R.id.my_ais_register_tv_request_otp:
<span class="nc" id="L377">                    getPresenter().requestVerifyIdentityWithOtpFlag(mobileNumber);</span>
<span class="nc" id="L378">                    getPresenter().setFocusBusinessType(BusinessType.POSTPAID);</span>
<span class="nc" id="L379">                    focusViewHolder = h;</span>
<span class="nc" id="L380">                    break;</span>
                case R.id.my_ais_register_btn_ok:
<span class="nc" id="L382">                    getPresenter().validateRequestVerifyOtp(mobileNumber, otp);</span>
<span class="nc" id="L383">                    focusViewHolder = h;</span>
                    break;
            }
<span class="nc" id="L386">        }</span>
    };
<span class="nc" id="L388">    private MobileRequestWithRequestOtpItemHolder.OnClickItemListener preAdapterListener = new MobileRequestWithRequestOtpItemHolder.OnClickItemListener() {</span>
        @Override
        public void onClick(MobileRequestWithRequestOtpItemHolder h, View v, String mobileNumber, String otp, int pos) {
<span class="nc bnc" id="L391" title="All 3 branches missed.">            switch (v.getId()) {</span>
                case R.id.my_ais_register_tv_request_otp:
<span class="nc" id="L393">                    getPresenter().requestVerifyIdentityWithOtpFlag(mobileNumber);</span>
<span class="nc" id="L394">                    getPresenter().setFocusBusinessType(BusinessType.PREPAID);</span>
<span class="nc" id="L395">                    focusViewHolder = h;</span>
<span class="nc" id="L396">                    break;</span>
                case R.id.my_ais_register_btn_ok:
<span class="nc" id="L398">                    getPresenter().validateRequestVerifyOtp(mobileNumber, otp);</span>
<span class="nc" id="L399">                    focusViewHolder = h;</span>
                    break;
            }
<span class="nc" id="L402">        }</span>
    };
<span class="nc" id="L404">    private MobileRequestWithRequestOtpItemHolder.OnClickItemListener fbbAdapterListener = new MobileRequestWithRequestOtpItemHolder.OnClickItemListener() {</span>
        @Override
        public void onClick(MobileRequestWithRequestOtpItemHolder h, View v, String mobileNumber, String otp, int pos) {
<span class="nc bnc" id="L407" title="All 3 branches missed.">            switch (v.getId()) {</span>
                case R.id.my_ais_register_tv_request_otp:
<span class="nc" id="L409">                    getPresenter().requestVerifyIdentityWithOtpFlag(mobileNumber);</span>
<span class="nc" id="L410">                    getPresenter().setFocusBusinessType(BusinessType.FIBRE);</span>
<span class="nc" id="L411">                    focusViewHolder = h;</span>
<span class="nc" id="L412">                    break;</span>
                case R.id.my_ais_register_btn_ok:
<span class="nc" id="L414">                    getPresenter().validateRequestVerifyOtp(mobileNumber, otp);</span>
<span class="nc" id="L415">                    focusViewHolder = h;</span>
                    break;
            }
<span class="nc" id="L418">        }</span>
    };


    //&lt;/editor-fold&gt;

    /********************/
    /** Private method **/
    /********************/
    //&lt;editor-fold desc=&quot;Private function folding&quot;&gt;
    private boolean isMobileGroupEmpty(MobileTypeGroup group) {
        return group.getPostpaidList().isEmpty()
                &amp;&amp; group.getPrepaidList().isEmpty()
                &amp;&amp; group.getFbbList().isEmpty();
    }

    private void clickAdd() {
        getPresenter().goToAddMobileNumberActivity(
                postAdapter.getConfirmMobileList(),
                preAdapter.getConfirmMobileList(),
                fbbAdapter.getConfirmMobileList(),
                postAdapter.getNoConfirmMobileList(),
                preAdapter.getNoConfirmMobileList(),
                fbbAdapter.getNoConfirmMobileList()
        );
    }

    private void clickNext() {
        getPresenter().requestConfirmRegister(
                postAdapter.getConfirmMobileList(),
                preAdapter.getConfirmMobileList(),
                fbbAdapter.getConfirmMobileList());
    }


    //&lt;/editor-fold&gt;


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>